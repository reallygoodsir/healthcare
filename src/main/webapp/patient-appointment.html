<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Healthcare â€” Patient Appointment</title>
    <style>
        :root{
          --bg:#f4f7fb;
          --card:#fff;
          --accent:#2563eb;
          --accent-hover:#1d4ed8;
          --danger:#dc2626;
          --text:#111827;
          --muted:#6b7280;
        }
        body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}
        header{background:var(--accent);color:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;}
        header h1{margin:0;font-size:1.5rem;}
        main{padding:2rem;max-width:800px;margin:auto;}
        .card{background:var(--card);padding:2rem;border-radius:0.5rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
        label{display:block;margin-top:1rem;font-weight:600;color:var(--muted);}
        p.readonly{margin:0.25rem 0 0;padding:0.5rem 0;font-size:1rem;color:var(--text);}
        textarea{width:100%;height:100px;padding:0.5rem;border:1px solid #ddd;border-radius:0.25rem;font-family:inherit;margin-top:0.25rem;font-size:1rem;}
        button{margin-top:1.5rem;padding:0.5rem 1rem;border:none;border-radius:0.375rem;cursor:pointer;font-size:1rem;}
        button.save{background:#10b981;color:#fff;}
        button.save:hover{background:#059669;}
        button.sign{background:var(--accent);color:#fff;}
        button.sign:hover{background:var(--accent-hover);}
        .actions{display:flex;gap:0.5rem;margin-top:1.5rem;}
    </style>
</head>
<body>
<header>
    <h1>Patient Appointment</h1>
</header>
<main>
    <div class="card">
        <label>First Name</label>
        <p id="firstName" class="readonly"></p>

        <label>Last Name</label>
        <p id="lastName" class="readonly"></p>

        <label>Birth Date</label>
        <p id="birthDate" class="readonly"></p>

        <label>Current Date</label>
        <p id="currentDate" class="readonly"></p>

        <label>Diagnosis</label>
        <textarea id="diagnosis"></textarea>
        <p id="diagnosisReadonly" class="readonly" style="display:none;"></p>

        <label>Recommendations</label>
        <textarea id="recommendations"></textarea>
        <p id="recommendationsReadonly" class="readonly" style="display:none;"></p>

        <div class="actions">
            <button class="save">Save</button>
            <button class="sign">Sign</button>
        </div>
    </div>
</main>

<script>
    const API_BASE = 'http://localhost:8080/healthcare/api';
    const diagnosisEl = document.getElementById('diagnosis');
    const recommendationsEl = document.getElementById('recommendations');
    const diagnosisROEl = document.getElementById('diagnosisReadonly');
    const recommendationsROEl = document.getElementById('recommendationsReadonly');
    const firstNameEl = document.getElementById('firstName');
    const lastNameEl = document.getElementById('lastName');
    const birthDateEl = document.getElementById('birthDate');
    const currentDateEl = document.getElementById('currentDate');
    const saveBtn = document.querySelector('.save');
    const signBtn = document.querySelector('.sign');

    let appointmentId = null;
    let patientId = null;
    let appointmentStatus = 'ONGOING';

    // Read appointmentId from URL
    const urlParams = new URLSearchParams(window.location.search);
    appointmentId = urlParams.get('appointmentId');

    if(!appointmentId){
        alert("No appointmentId provided in URL");
        throw new Error("Missing appointmentId");
    }

    function setCurrentDate(){
        const today = new Date().toISOString().split('T')[0];
        currentDateEl.textContent = today;
    }

    function updateUIBasedOnStatus(){
        if(appointmentStatus === 'COMPLETED'){
            diagnosisEl.style.display = 'none';
            recommendationsEl.style.display = 'none';
            diagnosisROEl.style.display = 'block';
            recommendationsROEl.style.display = 'block';
            saveBtn.style.display = 'none';
            signBtn.style.display = 'none';
        } else {
            diagnosisEl.style.display = 'block';
            recommendationsEl.style.display = 'block';
            diagnosisROEl.style.display = 'none';
            recommendationsROEl.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            signBtn.style.display = 'inline-block';
        }
    }

    async function loadAppointment(){
        try {
            const resp = await fetch(`${API_BASE}/appointments/${appointmentId}`);
            if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();
            appointmentStatus = data.status;
            patientId = data.patientId;
            updateUIBasedOnStatus();
        } catch(err){
            console.error('Failed to load appointment', err);
            alert('Failed to load appointment. Check console.');
        }
    }

    async function loadPatient(){
        if(!patientId) return;
        try {
            const resp = await fetch(`${API_BASE}/patients/${patientId}`);
            if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const patient = await resp.json();
            firstNameEl.textContent = patient.firstName || '';
            lastNameEl.textContent = patient.lastName || '';
            birthDateEl.textContent = patient.dateOfBirth || '';
        } catch(err){
            console.error('Failed to load patient', err);
        }
    }

    // Load outcome separately to handle COMPLETED status
    async function loadOutcome(){
        try {
            const resp = await fetch(`${API_BASE}/appointments/${appointmentId}/outcome`);
            if(resp.ok){
                const outcome = await resp.json();
                diagnosisEl.value = outcome.diagnosis || '';
                recommendationsEl.value = outcome.recommendations || '';
                diagnosisROEl.textContent = outcome.diagnosis || '';
                recommendationsROEl.textContent = outcome.recommendations || '';
            }
        } catch(err){
            console.error('Failed to load outcome', err);
        }
    }

    async function saveOutcome(sign=false){
        try {
            const payload = {
                diagnosis: diagnosisEl.value,
                recommendations: recommendationsEl.value
            };
            const resp = await fetch(`${API_BASE}/appointments/${appointmentId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(!resp.ok) throw new Error(`HTTP ${resp.status}`);

            if(sign){
                await fetch(`${API_BASE}/appointments/${appointmentId}/status?status=COMPLETED`, {method:'PATCH'});
                appointmentStatus = 'COMPLETED';
                alert('Appointment signed successfully!');
                window.location.reload();
            } else {
                alert('Appointment saved successfully!');
            }
            updateUIBasedOnStatus();
        } catch(err){
            console.error('Failed to save outcome', err);
            alert('Failed to save outcome. Check console.');
        }
    }

    saveBtn.onclick = ()=>saveOutcome(false);
    signBtn.onclick = ()=>saveOutcome(true);

    setCurrentDate();
    loadAppointment()
        .then(loadPatient)
        .then(loadOutcome);
</script>
</body>
</html>
