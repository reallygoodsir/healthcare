<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Healthcare â€” Service Appointments</title>
  <style>
    :root{
      --bg:#f4f7fb;
      --card:#fff;
      --accent:#2563eb;
      --accent-hover:#1d4ed8;
      --danger:#dc2626;
      --text:#111827;
      --muted:#6b7280;
    }
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{background:var(--accent);color:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;}
    header h1{margin:0;font-size:1.5rem;}
    main{padding:2rem;max-width:900px;margin:auto;}
    .card{background:var(--card);padding:2rem;border-radius:0.5rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:2rem;}
    label{display:block;margin-top:1rem;font-weight:600;color:var(--muted);}
    p.readonly{margin:0.25rem 0 0;padding:0.5rem 0;font-size:1rem;color:var(--text);}
    textarea{width:100%;height:100px;padding:0.5rem;border:1px solid #ddd;border-radius:0.25rem;font-family:inherit;margin-top:0.25rem;font-size:1rem;}
    button{margin-top:1.5rem;padding:0.5rem 1rem;border:none;border-radius:0.375rem;cursor:pointer;font-size:1rem;}
    button.save{background:#10b981;color:#fff;}
    button.save:hover{background:#059669;}
    button.sign{background:var(--accent);color:#fff;}
    button.sign:hover{background:var(--accent-hover);}
    .actions{display:flex;gap:0.5rem;margin-top:1.5rem;}
  </style>
</head>
<body>
<header>
  <h1>Service Appointment</h1>
</header>
<main>

  <div class="card">
    <label>First Name</label>
    <p id="firstName" class="readonly"></p>

    <label>Last Name</label>
    <p id="lastName" class="readonly"></p>

    <label>Birth Date</label>
    <p id="birthDate" class="readonly"></p>

    <label>Service Name</label>
    <p id="serviceName" class="readonly"></p>

    <label>Current Date</label>
    <p id="currentDate" class="readonly"></p>

    <label>Result</label>
    <textarea id="result"></textarea>
    <p id="resultReadonly" class="readonly" style="display:none;"></p>

    <div class="actions">
      <button class="save">Save</button>
      <button class="sign">Sign</button>
    </div>
  </div>

</main>

<script>
  const API_BASE = 'http://localhost:8080/healthcare/api';
  const resultEl = document.getElementById('result');
  const resultROEl = document.getElementById('resultReadonly');
  const firstNameEl = document.getElementById('firstName');
  const lastNameEl = document.getElementById('lastName');
  const birthDateEl = document.getElementById('birthDate');
  const serviceNameEl = document.getElementById('serviceName');
  const currentDateEl = document.getElementById('currentDate');
  const saveBtn = document.querySelector('.save');
  const signBtn = document.querySelector('.sign');

  let appointmentId = null;
  let patientId = null;
  let serviceId = null;
  let appointmentStatus = 'ONGOING';

  function setCurrentDate(){
      const today = new Date().toISOString().split('T')[0];
      currentDateEl.textContent = today;
      return today;
  }

  function updateUIBasedOnStatus(){
      if(appointmentStatus === 'COMPLETED'){
          resultEl.style.display = 'none';
          resultROEl.style.display = 'block';
          saveBtn.style.display = 'none';
          signBtn.style.display = 'none';
      } else {
          resultEl.style.display = 'block';
          resultROEl.style.display = 'none';
          saveBtn.style.display = 'inline-block';
          signBtn.style.display = 'inline-block';
      }
  }

  async function loadData(){
      try {
          const params = new URLSearchParams(window.location.search);
          appointmentId = params.get('appointmentId');
          patientId = params.get('patientId');
          serviceId = params.get('serviceId');

          if(!patientId || !appointmentId){
              alert('Missing patientId or appointmentId in URL');
              return;
          }

          setCurrentDate();

          // Fetch appointment status first
          const statusResp = await fetch(`${API_BASE}/patient-appointments/status/${appointmentId}`);
          if(statusResp.ok){
              const data = await statusResp.json();
              appointmentStatus = data.status || 'ONGOING';
          } else {
              console.warn('Could not fetch appointment status');
          }

          updateUIBasedOnStatus();

          // Load patient info
          const respPatient = await fetch(`${API_BASE}/patients/${patientId}`);
          if(respPatient.ok){
              const patient = await respPatient.json();
              firstNameEl.textContent = patient.firstName;
              lastNameEl.textContent = patient.lastName;
              birthDateEl.textContent = patient.dateOfBirth;
          } else {
              console.error('Failed to load patient info');
          }

          // Load service info
          if(serviceId){
              const respService = await fetch(`${API_BASE}/services/${serviceId}`);
              if(respService.ok){
                  const service = await respService.json();
                  serviceNameEl.textContent = service.name;
              } else {
                  console.error('Failed to load service info');
              }
          }

          // Load outcome info
          if(appointmentId){
              const respOutcome = await fetch(`${API_BASE}/patient-appointments/outcome/${appointmentId}`);
              if(respOutcome.ok){
                  const outcome = await respOutcome.json();
                  resultEl.value = outcome.result || '';
                  resultROEl.textContent = outcome.result || '';
              } else {
                  resultEl.value = '';
                  resultROEl.textContent = '';
              }
          }

          // Final UI adjustment (in case status changed)
          updateUIBasedOnStatus();

      } catch(err){
          console.error('Failed to load data', err);
          alert('Failed to load data');
      }
  }

  async function saveOutcome(sign=false){
      try {
          if(!appointmentId) return alert('No appointment selected!');
          const payload = { result: resultEl.value };
          const resp = await fetch(`${API_BASE}/patient-appointments/outcome/${appointmentId}`, {
              method: 'PUT',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify(payload)
          });
          if(!resp.ok) throw new Error(`HTTP ${resp.status}`);

          if(sign){
              const patchResp = await fetch(`${API_BASE}/patient-appointments/${appointmentId}/status?status=COMPLETED`, {method:'PATCH'});
              if(!patchResp.ok) throw new Error(`HTTP ${patchResp.status}`);
              appointmentStatus = 'COMPLETED';
              alert('Appointment signed successfully!');
          } else {
              alert('Appointment saved successfully!');
          }

          updateUIBasedOnStatus();
      } catch(err){
          console.error('Failed to save outcome', err);
          alert('Failed to save outcome: ' + err.message);
      }
  }

  saveBtn.onclick = ()=>saveOutcome(false);
  signBtn.onclick = ()=>saveOutcome(true);

  loadData();
</script>
</body>
</html>
